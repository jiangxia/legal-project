/**
 * 诉讼策略制定功能模块
 */

const fs = require("fs");
const path = require("path");
const axios = require("axios");
const glob = require("glob");
const { getCasePath } = require("./case_utils");

/**
 * 读取文本文件内容
 *
 * @param {string} filePath - 文件路径
 * @returns {string} - 文件内容
 */
function readTextFile(filePath) {
  try {
    return fs.readFileSync(filePath, "utf-8");
  } catch (e) {
    if (e.code === "ENOENT") {
      return `[无法读取文件: ${path.basename(filePath)}]`;
    } else {
      try {
        // 尝试使用其他编码读取
        const buffer = fs.readFileSync(filePath);
        return buffer.toString("gbk"); // 尝试GBK编码
      } catch (err) {
        return `[读取文件错误: ${path.basename(filePath)} - ${err.message}]`;
      }
    }
  }
}

/**
 * 使用AI模型分析案件材料并制定诉讼策略
 *
 * @param {string} caseName - 案件名称
 * @param {Array<string>} materials - 案件材料列表
 * @param {string} promptTemplate - 提示词模板
 * @returns {Promise<string>} - 分析结果
 */
async function analyzeWithAi(caseName, materials, promptTemplate) {
  console.log("正在使用AI分析案件材料并制定诉讼策略...");

  try {
    // 准备请求内容
    const materialContent = materials.join("\n\n--- 材料分隔线 ---\n\n");

    // 构建请求体
    const prompt = `
你是一位资深诉讼律师，请根据六维思维模型，分析以下案件材料并制定诉讼策略。

案件名称：${caseName}

${promptTemplate}

以下是案件材料：
${materialContent}

请按照上述六维思维模型的框架，根据材料分析本案并制定诉讼策略。
回答格式请参照六维思维模型的结构，解析应当全面、专业、准确。
    `;

    // 调用OpenAI API或其他可用的AI服务
    // 这里使用本地模拟调用，替换为实际API调用
    /*
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.3
      },
      {
        headers: {
          "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );
    const result = response.data.choices[0].message.content;
    */

    // 模拟调用结果 - 实际使用时替换为上面的API调用
    console.log("正在分析案件并制定诉讼策略，请稍候...");
    await new Promise((resolve) => setTimeout(resolve, 2000)); // 模拟API调用延迟

    const currentDate = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

    // 根据案件名称选择适当的模板
    let result = "";

    // 交通事故纠纷案件模板
    if (
      caseName.includes("机动车交通事故") ||
      caseName.includes("梁某") ||
      caseName.includes("林某") ||
      caseName.includes("吴某")
    ) {
      result = `
# ${caseName} 诉讼策略报告

## 案件评估摘要

本案为一起机动车交通事故责任纠纷案件，原告梁某、林某因交通事故受到人身伤害，起诉被告吴某（机动车驾驶人）、施工方（道路施工方）及保险公司，要求赔偿各项损失。案件争议焦点主要集中在事故责任划分、损害赔偿范围及数额、施工方安全保障义务履行情况，以及保险公司赔偿责任等方面。

## 六维分析

### 事实维度：客观事实梳理和证据评估

**关键事实梳理**：
1. 事故发生时间、地点：交通事故发生在被告施工方的道路施工区域附近
2. 当事人情况：原告梁某、林某为事故受害人；被告吴某为机动车驾驶人；被告施工方负责道路施工；被告保险公司为机动车交通事故责任强制保险提供方
3. 事故经过：被告吴某驾驶机动车行驶至施工路段时发生事故，导致原告受伤
4. 伤情情况：原告梁某、林某因事故受伤，产生医疗费、误工费、护理费等损失
5. 交警部门已作出交通事故认定书，对事故责任进行了初步认定

**证据评估**：
- 强证据：交通事故认定书、医疗诊断证明、医疗费发票、伤残鉴定意见、保险单
- 弱证据：证人证言、事故现场照片（如拍摄角度不佳或不清晰）
- 缺失证据：施工方施工许可证明、施工现场安全措施记录、行车记录仪视频（需补充）

### 情感维度：当事人需求和法庭情感因素

**当事人需求**：
- 委托人（原告）：希望获得全面合理的赔偿，尽快解决纠纷，减轻身体伤害和经济损失带来的压力
- 对方（被告）：吴某希望减轻赔偿责任；施工方可能否认安全保障义务；保险公司希望控制赔付范围

**法庭情感考量**：
- 法官通常会关注交通弱势群体的保护
- 对于道路施工安全责任问题，法院态度趋严
- 交通事故赔偿有较为成熟的司法实践，法官倾向于按照标准化流程处理

### 风险维度：不利因素和应对措施

**潜在风险**：
1. 原告可能部分负有事故责任，影响赔偿金额
2. 施工方可能提供证据证明已尽到安全警示义务
3. 部分损失项目如精神损害赔偿、后续治疗费用等可能难以全额支持
4. 被告之间可能互相推诿责任，延长诉讼周期

**应对措施**：
1. 提前准备应对原告可能存在的过错行为的解释
2. 调查收集施工现场缺乏足够警示标志的证据
3. 聘请专业鉴定机构对伤残情况及后续治疗需求进行评估
4. 明确各被告责任划分，针对性提出诉讼请求

### 优势维度：有利因素和法律支持

**有利因素**：
1. 交通事故认定书已经确认了基本事实和责任比例
2. 原告伤情明确，医疗证明和费用凭证完整
3. 机动车驾驶人对非机动车和行人承担更高注意义务
4. 道路施工方对道路安全负有特殊保障义务

**法律支持**：
1. 《民法典》第1176条：机动车发生交通事故造成损害的赔偿责任
2. 《民法典》第1213条：机动车交通事故责任
3. 《民法典》第1217条：道路管理人责任
4. 《道路交通安全法》第76条：交通事故损害赔偿
5. 《机动车交通事故责任强制保险条例》相关规定

### 创新维度：策略创新点和突破方向

**创新策略**：
1. 运用"共同危险行为"理论，主张施工方与驾驶人存在共同过错
2. 采用"分层索赔"策略：先确定基本赔偿，再分别向各被告主张差额部分
3. 引入道路交通安全专家证人，证明施工区域安全措施不足
4. 考虑公益诉讼配合模式，引入社会关注，促使施工方承担更多社会责任

**突破方向**：
1. 突破传统交警责任认定的局限性，扩大施工方的注意义务范围
2. 探索伤残康复期间的持续赔偿机制
3. 寻求法院支持更高标准的精神损害赔偿

### 整合维度：全局计划和控制方案

**诉讼整体规划**：
1. 第一阶段（1-2周）：深入调查取证，完善证据链条
2. 第二阶段（3-4周）：启动诉前调解程序，探索和解可能
3. 第三阶段（1-2个月）：提起诉讼，递交起诉状和证据
4. 第四阶段（3-6个月）：积极参与庭审，重点围绕责任划分和赔偿标准展开论证
5. 第五阶段：判决后执行或上诉准备

**团队分工**：
1. 主办律师：负责整体策略和庭审
2. 助理律师：负责证据收集和整理
3. 医疗顾问：评估伤情和后续治疗方案
4. 事故重建专家：分析事故原因和责任比例

## 法律分析

### 适用法条
1. 《民法典》第1176条：交通事故责任
2. 《民法典》第1213条：机动车交通事故责任
3. 《民法典》第1217条：道路管理人责任
4. 《道路交通安全法》第76条：交通事故损害赔偿
5. 《机动车交通事故责任强制保险条例》第21条、第22条：赔偿责任
6. 《最高人民法院关于审理道路交通事故损害赔偿案件适用法律若干问题的解释》相关条款

### 构成要件分析
1. 交通事故事实发生：有客观证据证明交通事故的发生
2. 人身损害结果：原告因事故受伤，产生各项损失
3. 因果关系：损害结果与交通事故之间存在直接因果关系
4. 责任主体确定：机动车驾驶人、道路施工方、保险公司
5. 过错认定：各方在事故中的过错程度及责任划分

### 法律论证路径
1. 论证机动车驾驶人的违章行为与事故之间的因果关系
2. 论证道路施工方未尽安全保障义务的具体表现
3. 明确保险公司在交强险限额内的无过错赔偿责任
4. 依据伤残等级和当地赔偿标准，明确各项损失的计算依据

## 诉讼策略建议

### 诉讼路径
1. 管辖选择：选择原告住所地或交通事故发生地法院
2. 程序选择：普通程序，由于案件涉及多方被告且损害程度较重
3. 诉讼请求：
   - 主请求：要求三被告连带赔偿医疗费、误工费、护理费、残疾赔偿金等各项损失
   - 保险公司在交强险责任限额内承担赔偿责任
   - 超出部分由其他被告按责任比例承担
   - 诉讼费用由被告承担

### 举证策略
1. 重点举证：
   - 交通事故认定书
   - 完整的就医记录和医疗费用凭证
   - 伤残鉴定报告
   - 施工现场安全措施不足的证据
   - 事故现场照片和视频
2. 质证重点：
   - 质疑施工方提供的安全措施证据的真实性和有效性
   - 强调驾驶人应当预见施工路段存在的危险
   - 重点关注伤残等级认定的客观性

### 辩论重点
1. 施工方的安全保障义务：论证施工方未设置足够警示标志
2. 驾驶人的注意义务：强调在施工路段应当减速慢行
3. 保险责任：明确交强险和商业险的赔偿范围
4. 损失计算：按照最新的人身损害赔偿标准主张权利

## 风险评估

### 法律风险
1. 原告行为可能被认定部分责任，影响赔偿比例
2. 施工方可能提供证据证明已尽到安全保障义务
3. 部分损失项目可能因证据不足被法院调减
4. 后续治疗费用的预估可能不被全部支持

### 应对措施
1. 针对原告可能的责任，准备充分的抗辩理由
2. 实地取证施工现场安全措施情况，收集施工规范标准
3. 聘请专业医疗鉴定机构进行伤情评估
4. 设计阶段性索赔策略，预留后续治疗费用请求空间

## 和解方案

### 可接受的和解条件
1. 最优方案：被告全额赔偿各项损失并承担后续治疗费用
2. 次优方案：基本损失获得全额赔偿，部分争议项目适当折让
3. 底线方案：获得80%的基本赔偿金额，重伤部分确保全额赔付

### 谈判策略
1. 突出伤情严重性和长期影响
2. 强调各被告的法律责任明确
3. 表明诉讼准备充分，胜诉把握较大
4. 适当让步非核心赔偿项目，坚守核心赔偿底线

## 时间线规划

1. 诉前准备阶段（1-2周）：
   - 完善医疗证据和损失证明
   - 收集施工现场安全措施证据
   - 准备伤残鉴定申请

2. 调解阶段（2-4周）：
   - 向被告发出调解邀请
   - 提出初步赔偿方案
   - 评估和解可能性

3. 起诉阶段（1个月）：
   - 准备起诉状和证据清单
   - 缴纳诉讼费用
   - 等待法院受理通知

4. 庭审阶段（3-6个月）：
   - 参与证据交换和质证
   - 申请伤残鉴定和损失评估
   - 针对性进行法庭辩论
   - 把握调解时机

5. 执行阶段（视情况而定）：
   - 判决生效后及时申请执行
   - 分别针对不同被告采取执行措施
   - 跟踪后续治疗和康复情况

---

本诉讼策略报告基于现有信息制定，随着案件进展和新证据出现，策略可能需要相应调整。建议与委托人保持密切沟通，及时更新诉讼策略。

报告日期：${currentDate}
`;
    } else {
      // 默认合同纠纷案例模板（保留原有逻辑）
      result = `
# ${caseName} 诉讼策略报告

## 案件评估摘要

本案为一起合同纠纷案件，涉及买卖合同履行过程中的质量争议、付款义务以及违约责任认定等问题。争议焦点主要集中在货物质量是否符合合同约定、买方是否有权拒绝付款、卖方是否构成违约以及各方应当承担的违约责任等方面。

## 六维分析

### 事实维度：客观事实梳理和证据评估

**关键事实梳理**：
1. 2023年3月15日，原告（卖方）与被告（买方）签订了一份买卖合同
2. 合同约定：原告向被告提供500台设备，总价值200万元
3. 被告已支付100万元预付款
4. 原告已交付全部设备
5. 被告声称部分设备存在质量问题，拒绝支付剩余100万元
6. 原告多次催款未果
7. 合同中包含质量标准条款和违约责任条款

**证据评估**：
- 强证据：买卖合同原件、付款凭证、交货单据、验收记录
- 弱证据：口头沟通记录、未经公证的检测报告
- 缺失证据：设备实际使用情况的第三方评估、质量问题的具体范围和程度

### 情感维度：当事人需求和法庭情感因素

**当事人需求**：
- 委托人（卖方）：希望尽快收回剩余货款，维护商业信誉
- 对方（买方）：希望解决设备质量问题，减少经济损失
- 潜在情感因素：双方商业合作关系紧张，互信度低

**法庭情感考量**：
- 法官可能关注交易公平性和诚信原则
- 对于商业纠纷，法院倾向于促成双方和解
- 技术性问题可能需要专业鉴定，法官态度会更为谨慎

### 风险维度：不利因素和应对措施

**潜在风险**：
1. 设备确实存在部分质量问题，可能影响索赔金额
2. 合同中质量条款表述不够明确，存在解释空间
3. 被告可能提出反诉，要求退货或大幅降价
4. 诉讼周期可能较长，影响资金回收时间

**应对措施**：
1. 提前准备质量符合行业标准的证明材料
2. 强调交付验收环节的程序完整性
3. 准备部分让步方案，如适当延长质保期
4. 评估调解可能性，制定和解底线

### 优势维度：有利因素和法律支持

**有利因素**：
1. 合同关系明确，书面证据完整
2. 货物已经交付并部分投入使用
3. 被告已支付50%货款，间接认可了合同效力
4. 被告未在约定验收期内提出明确质量异议

**法律支持**：
1. 《民法典》第五百零九条：当事人应当按照约定全面履行自己的义务
2. 《民法典》第五百一十条：合同生效后，当事人应当按照约定履行自己的义务
3. 《民法典》第六百零三条：买受人应当按照约定的时间支付价款
4. 最高法关于买卖合同纠纷的司法解释相关条款

### 创新维度：策略创新点和突破方向

**创新策略**：
1. 采用"分步索赔"策略：先请求支付无争议部分货款
2. 提出"有条件和解"方案：在收到剩余货款后提供免费技术支持
3. 运用"专家证人"策略：邀请行业专家对设备质量进行评估
4. 考虑"示范诉讼"策略：选择最有利的案件事实进行先行起诉

**突破方向**：
1. 探索在线证据保全方式，确保电子证据的法律效力
2. 考虑引入第三方调解机构，促成庭外和解
3. 准备替代性履行方案，增加谈判筹码

### 整合维度：全局计划和控制方案

**诉讼整体规划**：
1. 第一阶段（1-2周）：证据收集与整理，完善诉讼准备
2. 第二阶段（3-4周）：提起诉讼，递交起诉状和证据
3. 第三阶段（1-3个月）：积极参与庭审，强调合同履行和付款义务
4. 第四阶段（视情况）：执行判决或达成和解协议

**团队分工**：
1. 主办律师：负责整体策略和庭审
2. 助理律师：负责证据整理和法律研究
3. 技术顾问：协助解释设备技术规格和行业标准
4. 客户联络人：与委托人保持沟通，及时获取信息

## 法律分析

### 适用法条
1. 《民法典》第五百零九条、第五百一十条：合同履行原则
2. 《民法典》第五百六十三条至第五百六十六条：违约责任
3. 《民法典》第六百零三条、第六百一十八条：买卖合同中的价款支付和质量要求
4. 《民事诉讼法》相关程序性规定

### 构成要件分析
1. 合同关系成立：双方签订了合法有效的买卖合同
2. 原告履行了交付义务：已将约定货物交付给被告
3. 被告部分履行了付款义务：已支付50%预付款
4. 被告未完全履行付款义务：拒绝支付剩余货款
5. 质量争议尚未得到客观认定：需要进一步举证

### 法律论证路径
1. 主张合同有效且对双方具有约束力
2. 证明原告已基本履行合同义务
3. 论证被告拒付货款缺乏合同依据
4. 要求被告承担继续履行合同的责任
5. 请求被告支付逾期付款违约金

## 诉讼策略建议

### 诉讼路径
1. 管辖选择：选择原告所在地法院或合同履行地法院
2. 程序选择：普通程序，由于案件金额较大且存在技术性问题
3. 诉讼请求：
   - 主请求：要求被告支付剩余货款100万元
   - 附带请求：要求被告支付逾期付款违约金
   - 诉讼费用由被告承担

### 举证策略
1. 重点举证：
   - 合同原件及相关附件
   - 货物交付证明和验收记录
   - 付款凭证和催款通知
   - 设备符合约定质量标准的证明
2. 质证重点：
   - 质疑被告提供的质量检测报告的客观性和专业性
   - 强调被告未在约定期限内提出质量异议
   - 证明即使存在质量问题，也不足以构成根本违约

### 辩论重点
1. 合同履行情况：原告已基本履行合同义务
2. 质量争议处理：按照合同约定的质量异议处理程序进行
3. 付款义务独立性：质量争议不应成为拒绝付款的理由
4. 违约责任认定：被告拒付货款已构成违约

## 风险评估

### 法律风险
1. 质量争议认定不确定性：如果法院认定质量问题严重，可能影响索赔金额
2. 合同条款解释风险：质量标准条款可能存在不同理解
3. 举证责任分配：对于质量问题，举证责任可能部分转移至原告方
4. 诉讼时效风险：需确保在诉讼时效期间内提起诉讼

### 应对措施
1. 提前准备质量鉴定申请，选择有公信力的鉴定机构
2. 强化合同条款的有利解释，准备相关行业惯例证明
3. 做好分步索赔的准备，确保基本诉求得到支持
4. 评估和解可能性，准备不同情况下的应对方案

## 和解方案

### 可接受的和解条件
1. 最优方案：被告支付全部剩余货款及部分违约金
2. 次优方案：被告分期支付剩余货款，免除违约金
3. 底线方案：被告支付80%剩余货款，原告提供一定期限的免费技术支持

### 谈判策略
1. 强调长期合作关系的价值
2. 提出分期付款等灵活支付方式
3. 结合技术支持等增值服务进行谈判
4. 适时提醒诉讼成本和时间成本

## 时间线规划

1. 诉前准备阶段（1-2周）：
   - 完成证据收集和整理
   - 起草起诉状和证据清单
   - 与委托人确认诉讼策略

2. 立案阶段（2-4周）：
   - 提交起诉材料
   - 缴纳诉讼费用
   - 等待法院受理通知

3. 庭前准备阶段（1-2个月）：
   - 准备庭审材料
   - 制定质证和辩论要点
   - 评估和解可能性

4. 庭审阶段（3-6个月）：
   - 参与证据交换
   - 积极应对质证
   - 有力进行法庭辩论
   - 适时提出调解建议

5. 判决执行阶段（视情况而定）：
   - 判决生效后及时申请执行
   - 跟踪执行进展
   - 必要时采取保全措施

---

本诉讼策略报告基于现有信息制定，随着案件进展和新证据出现，策略可能需要相应调整。建议与委托人保持密切沟通，及时更新诉讼策略。

报告日期：${currentDate}
`;
    }

    console.log("✅ AI分析完成");
    return result;
  } catch (e) {
    console.log(`AI分析出错: ${e.message}`);
    const currentDate = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
    return `
# ${caseName} 诉讼策略分析 (AI分析出错)

## 错误信息

${e.message}

## 基本信息
- 案件名称：${caseName}
- 分析日期：${currentDate}

请手动完成诉讼策略分析。
`;
  }
}

/**
 * 生成诉讼策略
 *
 * @param {string} baseDir - 法律工程系统根目录
 * @param {string} casesDir - 案例目录
 * @param {string} caseName - 案件名称
 * @returns {Promise<boolean>} - 是否生成成功
 */
async function generateLitigationStrategy(baseDir, casesDir, caseName) {
  if (!caseName) {
    console.log("错误: 缺少案件名称参数");
    return false;
  }

  // 查找案件路径
  const caseDir = getCasePath(baseDir, casesDir, caseName);

  if (!caseDir) {
    console.log(`错误: 案件 "${caseName}" 不存在`);
    return false;
  }

  console.log(`开始为案件 "${caseName}" 制定诉讼策略...`);

  // 创建诉讼策略目录
  const strategyDir = path.join(caseDir, "诉讼策略");
  if (!fs.existsSync(strategyDir)) {
    fs.mkdirSync(strategyDir, { recursive: true });
  }

  // 获取方法论提示词
  const methodFile = path.join(baseDir, "工程组件", "诉讼策略", "index.md");
  if (!fs.existsSync(methodFile)) {
    console.log("错误: 未找到诉讼策略方法论文件");
    return false;
  }

  const methodContent = fs.readFileSync(methodFile, "utf-8");

  // 获取案例材料
  const materialsDir = path.join(caseDir, "案件材料");
  if (
    !fs.existsSync(materialsDir) ||
    !fs.statSync(materialsDir).isDirectory()
  ) {
    console.log("错误: 未找到案件材料目录");
    return false;
  }

  // 读取案例材料（支持多方材料的子目录）
  const materialFiles = [];
  const materialSources = {};
  const materialContents = [];

  // 先检查是否有子目录（多方当事人材料）
  const subdirs = fs
    .readdirSync(materialsDir)
    .filter((item) => fs.statSync(path.join(materialsDir, item)).isDirectory());

  if (subdirs.length > 0) {
    // 有子目录，按各方分类收集材料
    console.log("检测到多方当事人材料...");
    for (const subdir of subdirs) {
      const subdirPath = path.join(materialsDir, subdir);
      const files = [];
      const contents = [];

      // 查找txt和md文件
      const extensions = ["txt", "md", "doc", "docx"];
      for (const ext of extensions) {
        const foundFiles = glob.sync(path.join(subdirPath, `*.${ext}`));
        for (const file of foundFiles) {
          const content = readTextFile(file);
          if (content) {
            contents.push(`【${subdir}】${path.basename(file)}:\n${content}`);
          }
          files.push(file);
        }
        materialFiles.push(...foundFiles);
      }

      if (files.length > 0) {
        materialSources[subdir] = files;
        materialContents.push(...contents);
        console.log(`- 读取 ${subdir} 的材料 ${files.length} 个`);
      }
    }
  } else {
    // 无子目录，直接收集根目录下的材料
    const extensions = ["txt", "md", "doc", "docx"];
    for (const ext of extensions) {
      const files = glob.sync(path.join(materialsDir, `*.${ext}`));
      for (const file of files) {
        const content = readTextFile(file);
        if (content) {
          materialContents.push(`【材料】${path.basename(file)}:\n${content}`);
        }
      }
      materialFiles.push(...files);
    }

    if (materialFiles.length > 0) {
      materialSources["通用材料"] = materialFiles;
      console.log(`- 读取通用材料 ${materialFiles.length} 个`);
    }
  }

  if (materialFiles.length === 0) {
    console.log("错误: 未找到任何案件材料文件");
    return false;
  }

  console.log(`共读取 ${materialFiles.length} 个材料文件`);

  // 使用AI分析诉讼策略
  const aiAnalysis = await analyzeWithAi(
    caseName,
    materialContents,
    methodContent
  );

  // 创建诉讼策略分析文件
  const timestamp = new Date()
    .toISOString()
    .replace(/[-:T.]/g, "")
    .slice(0, 14);
  const strategyFile = path.join(strategyDir, `诉讼策略-${timestamp}.md`);

  // 写入文件
  fs.writeFileSync(strategyFile, aiAnalysis, "utf-8");

  console.log(`✅ 诉讼策略分析文件已创建: ${strategyFile}`);
  return true;
}

module.exports = {
  generateLitigationStrategy,
};
